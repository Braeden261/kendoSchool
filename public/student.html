<html>
    <head>
        <title>Kendo Gakko</title>
        <script src="/js/aframe-v0.8.2.min.js"></script>
        <script src="/js/aframe-physics-system.min.js"></script>
        <script src="/js/aframe-physics-extras.min.js"></script>
        <script src="js/super-hands.min.js"></script>
        <script src="js/event-manager-component.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script src="/js/hit-sound-component.js"></script>

    </head>
    <body>
        <a-scene loading-screen="dotsColor: #e74c3c;
                                 backgroundColor: #353535;
                                 enabled: true;"
                 physics="debug: true;
                          gravity: -9;
                          maxInterval: 0.02;
                          iterations: 20;
                          restitution: 0.1;"
                 shadow="type: pcfsoft;" 
                 fog="type: linear;
                      color: #e0bfb6;
                      near: 5.8;
                      far: 45.88;"
        >
            <a-assets>
                <!-- Mixins -->
                <a-mixin    id="lantern-light"
                            light = "type: spot; angle: 50; distance: 5; decay: 1; penumbra: 1; color: #ffd779; intensity: 0.5;"
                            rotation = "-90 0 0"
                ></a-mixin>

                <!-- Textures -->
                <img id = "skymap" src = "/assets/textures/skyTexture/sky-02.png">
                <img id = "dojo-tex" src = "/assets/textures/dojoTexture/dojo_wallsFloors_texture-02.png">
                <img id = "dummyMap" src = "/assets/textures/dummyTexture/TexturePNG/dummyTexture.png">
                <img id = "shinai-tex" src = "/assets/textures/swordTexture/TexturePNG/swordTexture.png">

                <img id = "lantern-tex" src = "/assets/textures/lanternTexture/lantern_tex.png">
                <img id = "bgSword-tex" src = "/assets/textures/backgroundSwordTexture/TexturePNG/swordTexture.png">


                <!-- Models -->
                <a-asset-item id="dojo-obj" src="/assets/models/objFiles/dojo/dojo_structure.obj"></a-asset-item>
                <a-asset-item id="windows-obj" src="/assets/models/objFiles/dojo/dojo_windows.obj"></a-asset-item>


                <a-asset-item id="shinai-obj" src="/assets/models/objFiles/sword/sword_v003.obj"></a-asset-item>
                <a-asset-item id="dummy-obj" src="/assets/models/objFiles/dummy/trainingDummy.obj"></a-asset-item>

                <a-asset-item id="lanternFrames-obj" src="/assets/models/objFiles/lantern/lanterns_frames_lines.obj"></a-asset-item>
                <a-asset-item id="lanternBodies-obj" src="/assets/models/objFiles/lantern/lanterns_bodies.obj"></a-asset-item>
                
                <a-asset-item id="lanternSingle-obj" src="/assets/models/objFiles/lantern/lantern_menu.obj"></a-asset-item>

                <a-asset-item id="bgSword-obj" src="/assets/models/objFiles/bg_models/bg_sword.obj"></a-asset-item>



                <audio id='hit-sound' src='/assets/sounds/effects/hitSound.mp3'></audio>
                <audio id="nature-sound" loop>
                    <source  src="/assets/sounds/ambientSounds.mp3" type="audio/mp3">
                </audio>

                <!-- Mixins -->
                <a-mixin id="controller"
                         super-hands="colliderEvent: collisions;
                                      colliderEventProperty: els;
                                      colliderEndEvent: collisions;
                                      colliderEndEventProperty: clearedEls;
                                      grabStartButtons: gripdown, pointdown, triggerdown;
                                      grabEndButtons: gripup, pointup, triggerup"
                         static-body="shape: none;"
                         shape__palm="shape: box;
                                      halfExtents: 0.05 0.025 0.02;
                                      offset: 0 -0.015 0.025;"
                         physics-collider
                         collision-filter="group: hands;
                                           collidesWith: swords, objs;
                                           collisionForces: false;"
                ></a-mixin>
                
            </a-assets>

            <!-- C A M E R A   &   V R   H A N D S -->
            <!--user POV = ~1.8m (6ft) base height + ~0.4m raised platform)-->
            <a-entity   id="head"
                        camera
                        look-controls
                        position="0 1.8 1.00"
            ></a-entity>
            
            <!-- Right Hand Controller-->
            <a-entity   id="handRight"
                        hand-controls="right"
                        mixin="controller"
            ></a-entity>

            <!-- Left Hand Controller-->
            <a-entity   id="handLeft"
                        hand-controls="left"
                        mixin="controller"
            ></a-entity>
            
            <!-- L I G H T S -->
            <a-entity   light = "type: spot;
                                 intensity: 0.5;
                                 angle: 60;
                                 penumbra: 0.9;
                                 color: #fff8e8;
                                 castShadow: true;
                                 shadowBias: -0.000001;
                                 shadowMapWidth: 2048;
                                 shadowMapHeight: 2048;"
                        position = "0 7.33 0"
                        rotation = "-90 0 0"
            ></a-entity>
            <a-entity   light = "type: ambient;
                                 intensity: 0.23;
                                 color: #f86605;"></a-entity>
            <a-entity   light = "type: spot;
                                 angle: 25;
                                 penumbra: 1;
                                 color: #ffefca"
                        position = "0 4.95 -14.27"
                        rotation = "-90 0 0"
            ></a-entity>
            
            <!-- M O D E L S -->
            <!-- dojo -->
            <a-entity   id="dojo"
                        obj-model="obj: #dojo-obj"
                        scale="1.0 1.0 1.0"
                        position="0 0 0"
                        material="src:#dojo-tex;
                                  roughness:0.7;
                                  metalness:0;
                                  transparent:true;
                                  opacity:1;"
                        shadow="cast:true;
                                receive:true;"
            >
                <!-- environment hit boxes -->
                <!--platform-->
                <a-entity   id="groundPlane-platform"
                            static-body
                            geometry="primitive: box;
                                      height: 0.5;
                                      width: 3.658;
                                      depth: 3.658;"
                            collision-filter="group: environment;
                                              collidesWith: swords, objs;
                                              collisionForces: true;"
                            material="color: #bdc3c7;
                                      roughness: 0.7;
                                      metalness: 0;
                                      visible: false;
                                      wireframe: false;"
                            position="0 0.35 0"
                ></a-entity>

                <!--ground-->
                <a-entity   id="groundPlane-floor"
                            static-body
                            geometry="primitive: box;
                                      height: 0.5;
                                      width: 16.2;
                                      depth: 25.5;"
                            collision-filter="group: environment;
                                              collidesWith: swords, objs;
                                              collisionForces: true;"
                            material="color: #bdc3c7;
                                      roughness: 0.7;
                                      metalness: 0;
                                      visible: false;
                                      wireframe: false;"
                            position="0 -0.25 0"
                ></a-entity>
            </a-entity><!-- end of dojo-->
            
            <a-entity   id="windows"
                        obj-model="obj:#windows-obj"
                        scale="1.0 1.0 1.0"
                        position="0 0 0"
                        material="color: #fff9de;
                                  roughness :0.7;
                                  metalness: 0;
                                  transparent: true;
                                  opacity: 0.85;"
                        shadow="cast: true;
                                receive: true;"
            ></a-entity>

            <!--Lanterns-->
            <a-entity   id="lantern-frames"
                        obj-model="obj:#lanternFrames-obj"
                        scale="1.0 1.0 1.0"
                        position="0 0 0"
                        material="src:#lantern-tex; roughness:0.7; metalness:0; transparent:true; opacity:1;"
                        shadow="cast:true; receive:true;"
            ></a-entity>

            <a-entity   id="lantern-bodies"
                        obj-model="obj:#lanternBodies-obj"
                        scale="1.0 1.0 1.0"
                        position="0 0 0"
                        material="src:#lantern-tex; roughness:0.7; metalness:0; transparent:true; opacity:0.95; emissive:#ffe3a4; emissiveIntensity:0.3;"
                        shadow="cast:true; receive:true;"
            ></a-entity>

            <a-entity   id="lanternLight"
                        mixin="lantern-light"
                        position="-4.915 2.52 -10.0"
            ></a-entity>

            <a-entity   id="lanternLight"
                        mixin="lantern-light"
                        position="-4.915 2.52 -5.0"
            ></a-entity>

            <a-entity   id="lanternLight"
                        mixin="lantern-light"
                        position="-4.915 2.52 0.0"
            ></a-entity>

            <a-entity   id="lanternLight"
                        mixin="lantern-light"
                        position="-4.915 2.52 5.01"
            ></a-entity>

            <a-entity   id="lanternLight"
                        mixin="lantern-light"
                        position="-4.915 2.52 10.01"
            ></a-entity>

            <a-entity   id="lanternLight"
                        mixin="lantern-light"
                        position="4.91 2.52 -10.01"
            ></a-entity>

            <a-entity   id="lanternLight"
                        mixin="lantern-light"
                        position="4.91 2.52 -5.002"
            ></a-entity>

            <a-entity   id="lanternLight"
                        mixin="lantern-light"
                        position="4.91 2.52 -0.001"
            ></a-entity>

            <a-entity   id="lanternLight"
                        mixin="lantern-light"
                        position="4.91 2.52 4.997"
            ></a-entity>

            <a-entity   id="lanternLight"
                        mixin="lantern-light"
                        position="4.91 2.52 10.0"
            ></a-entity>


            <!--Physical Menu-->
            <a-box
                    id="anchorA"
                    position="-0.5 8 0"
                    scale=" 0.5 0.5 0.5"
                    static-body
            ></a-box>

            <a-box
                    id="anchorB"
                    position="0.5 8 0"
                    scale=" 0.5 0.5 0.5"
                    static-body
            ></a-box>


            <a-entity

                    spring="target: #anchorA;
                            damping:100;
                            stiffness: 1000;
                            restLength: 5;
                            localAnchorA: 0 0.5 0;"

                    id="lantern-continue"
                    position="-0.5 4 0"
                    body="  
                            type: dynamic;
                            mass: 50;
                            linearDamping: 0.02;
                            shape: none;"
                    collision-filter="
                            group: objs;
                            collidesWith: hands, swords, objs, environment;
                            collisionForces: true;"
                    shape__core="shape: cylinder;
                            height: 0.5;
                            radiusTop: 0.25;
                            radiusBottom: 0.25;
                            offset: 0 0.3 0;
                            numSegments: 16;"
                            >
                <a-entity   
                    obj-model="obj:#lanternSingle-obj"
                    scale="1 1 1"
                    material="src:#lantern-tex; roughness:0.7; metalness:0; transparent:true; opacity:1;"
                    shadow="cast:false; receive:true;"
                ></a-entity>
            </a-entity>
            <a-entity

                    spring="target: #anchorB;
                            damping:100;
                            stiffness: 1000;
                            restLength: 5;
                            localAnchorA: 0 0.5 0;"

                    id="lantern-repeat"
                    position="0.5 4 0"
                    body="  
                            type: dynamic;
                            mass: 50;
                            linearDamping: 0.02;
                            shape: none;"
                    collision-filter="
                            group: objs;
                            collidesWith: hands, swords, objs, environment;
                            collisionForces: true;"
                    shape__core="shape: cylinder;
                            height: 0.5;
                            radiusTop: 0.25;
                            radiusBottom: 0.25;
                            offset: 0 0.3 0;
                            numSegments: 16;"
                            >
                <a-entity  
                    obj-model="obj:#lanternSingle-obj"
                    scale="1 1 1"
                    material="src:#lantern-tex; roughness:0.7; metalness:0; transparent:true; opacity:1;"
                    shadow="cast:false; receive:true;"
                ></a-entity>
            </a-entity>

            <!--dummy-->
            <a-entity   id="dummy-rig"
                        position="0 1.5 -1.0"
            >
                <a-entity   id="dummy-box"
                            body="type: dynamic;
                                  mass: 1;
                                  linearDamping: 0.02;
                                  shape: none;"
                            collision-filter="group: objs;
                                              collidesWith: hands, swords, objs, environment;
                                              collisionForces: true;"
                            shape__core="shape: cylinder;
                                         height: 1.64;
                                         radiusTop: 0.12;
                                         radiusBottom: 0.12;
                                         offset: 0 0.04 0;
                                         numSegments: 16;"
                            shape__face="shape: box;
                                         height: 0.4;
                                         halfExtents: 0.04 0.04 0.14;
                                         offset: -0.01 0.75 0.255;"
                            shape__arms="shape: box;
                                         height: 0.4;
                                         halfExtents: 0.54 0.05 0.05;
                                         offset: 0 0.4 -0.02;"
                            shape__leg="shape: box;
                                         halfExtents: 0.03 0.3 0.2;
                                         offset: 0 -0.5 0.3;"
                            shape__base="shape: box;
                                         halfExtents: 0.3 0.016 0.3;
                                         offset: 0 -0.84 0;"
                            shape__foot="shape: box;
                                         halfExtents: 0.17 0.016 0.17;
                                         offset: 0 -0.84 0.623;"
                >
                    <a-entity   id="dummy"
                                obj-model="obj:#dummy-obj"
                                position="0 -0.85 0"
                                scale="1.0 1.0 1.0"
                                rotation="0 90 0"
                                material="src: #dummyMap;
                                          roughness: 0.7;
                                          metalness: 0;"
                    ></a-entity>
                </a-entity>
            </a-entity>
            
            <!--shinai-->
            <a-entity   id="shinai"
                        obj-model="obj:#shinai-obj"
                        hit-sound-component
                        hoverable
                        body="type: dynamic;
                              mass: 100;
                              shape: none;"
                        shape__blade="shape: cylinder;
                                      height: 1.05;
                                      offset: 0 0.12 0;
                                      radiusTop: 0.02;   
                                      radiusBottom: 0.016;
                                      numSegments: 16;"
                        shape__guard="shape: cylinder;
                                      height: 0.017;
                                      offset: 0 -0.399 0;
                                      radiusTop: 0.05;
                                      radiusBottom: 0.05;
                                      numSegments: 24;"
                        shape__handle="shape: cylinder;
                                       height: 0.232;
                                       offset: 0 -0.528 0;
                                       radiusTop: 0.018;
                                       radiusBottom: 0.018;
                                       numSegments: 8;"
                        collision-filter="group: swords;
                                          collidesWith: hands, objs, environment;
                                          collisionForces: true;"
                        material="src: #shinai-tex;
                                  roughness: 0.7;
                                  metalness: 0.2;
                                  visible: true;"
                        position="0 2 0"
            >
                <!--sounds-->
                <a-entity id="hitSnd" sound="src:#hit-sound"></a-entity>
            </a-entity>

            <a-entity   id="bgSword"
                        obj-model="obj:#bgSword-obj"
                        scale="1.0 1.0 1.0"
                        position="0 0.5 -4"
                        material="src:#bgSword-tex; roughness:0.7;"
                        shadow="cast:true; receive:true;"
            ></a-entity>

            <!-- Sky Dome -->
            <a-entity   id = "sky"
                        geometry = "primitive: sphere;
                                    radius: 500;"
                        material = "shader: flat;
                                    src: #skymap;
                                    side: back;
                                    height: 2048;
                                    width: 2048;
                                    fog: false;"
            ></a-entity>
            
            <!-- Event Handler -->
            <a-entity   id="Chandler"
                        event-manager
            ></a-entity>
       </a-scene>
       <script>
            let socket = io();

            let passed = 0;
            let failed = 0;

            socket.on('connect', function(userData){
                console.log('connected');
            });

            socket.on('send_instruction', function(data){
                console.log('Sequence: ' + data.sequence);
            });

            socket.on('percResp', function(data){
                console.log('percentCheck');
                for (let i =0; i < data.numResponseSeq; i++){
                    if (data.responseSeq[i] == true){
                        passed++;
                    }
                    else{
                        failed++;
                    }
                }
                passed = 100 * ( passed/(data.numResponseSeq) );
                failed = 100 * ( failed/(data.numResponseSeq) );
                console.log("Passed:", passed, "%");
                console.log("Failed:", failed, "%");
            });


            window.onload = function(){
                let ambient = document.querySelector('#nature-sound');
                ambient.volume = 0.01;
                ambient.play();
            }
        </script>
    </body>
</html>